<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORACLE / ADA Dashboard</title>
    <style>
        /* Diseño base - Tonos oscuros */
        :root { 
            --bg: #0b1120; 
            --card-bg: #1e293b; 
            --text-main: #f8fafc; 
            --text-muted: #94a3b8; 
            --minswap-color: #38bdf8; /* Azul Claro */
            --vyfi-color: #c084fc;    /* Lila Claro */
            --total-color: #fbbf24;   /* Dorado para el Total */
        }

        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            justify-content: center; 
            padding: 30px 15px; 
            margin: 0; 
        }

        .dashboard { width: 100%; max-width: 480px; }

        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { margin: 0; font-size: 2rem; letter-spacing: 2px; }
        .ada-ticker { background: rgba(255, 255, 255, 0.05); padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; color: var(--text-muted); display: inline-block; margin-top: 10px; }

        /* Tarjetas */
        .card { 
            background: var(--card-bg); 
            border-radius: 16px; 
            padding: 25px; 
            margin-bottom: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); 
            position: relative;
        }

        .card-total { border: 1px solid rgba(251, 191, 36, 0.3); text-align: center; }
        .card-minswap { border-left: 5px solid var(--minswap-color); }
        .card-vyfi { border-left: 5px solid var(--vyfi-color); }

        .dex-title { font-size: 0.8rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; position: absolute; top: 25px; right: 25px; padding: 4px 10px; border-radius: 8px; }
        .title-minswap { background: rgba(56, 189, 248, 0.1); color: var(--minswap-color); }
        .title-vyfi { background: rgba(192, 132, 252, 0.1); color: var(--vyfi-color); }

        .data-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: bold; margin-bottom: 5px; display: block; }
        .price-value { font-size: 2.2rem; font-weight: 900; margin-bottom: 20px; }
        
        .tvl-container { border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; display: flex; justify-content: space-between; align-items: center; }
        .tvl-value { font-size: 1.2rem; font-weight: 700; }
        .tvl-minswap { color: var(--minswap-color); }
        .tvl-vyfi { color: var(--vyfi-color); }

        .total-value { font-size: 2.8rem; font-weight: 900; color: var(--total-color); margin: 10px 0; }

        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-ok { background-color: #4ade80; box-shadow: 0 0 8px #4ade80; }
        .status-loading { background-color: #facc15; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="header">
        <h1>ORACLE HUB</h1>
        <div id="ada-ticker" class="ada-ticker">ADA/USD: Cargando...</div>
    </div>

    <div class="card card-total">
        <span class="data-label">TVL Total en Cardano (Minswap + VyFi)</span>
        <div id="total-tvl" class="total-value">... ₳</div>
        <div style="font-size: 0.8rem; color: var(--text-muted);">
            <span id="status-main" class="status-dot status-loading"></span> Sincronizando Blockchain
        </div>
    </div>

    <div class="card card-minswap">
        <span class="dex-title title-minswap">Minswap</span>
        <span class="data-label">Precio ORACLE</span>
        <div id="price-minswap" class="price-value">... ₳</div>
        <div class="tvl-container">
            <span class="data-label" style="margin:0;">Liquidez (TVL)</span>
            <span id="tvl-minswap" class="tvl-value tvl-minswap">... ₳</span>
        </div>
    </div>

    <div class="card card-vyfi">
        <span class="dex-title title-vyfi">VyFi</span>
        <span class="data-label">Precio ORACLE</span>
        <div id="price-vyfi" class="price-value">... ₳</div>
        <div class="tvl-container">
            <span class="data-label" style="margin:0;">Liquidez (TVL)</span>
            <span id="tvl-vyfi" class="tvl-value tvl-vyfi">... ₳</span>
        </div>
    </div>
</div>

<script>
    const ORACLE_ID = "328a18bac517630826a106bff1a55caf455de84cdba98416f8e093b27393c37310950f58596be5013b942d52accb931c2800cf132db36fb5fd7d71c4";

    async function fetchData() {
        try {
            // 1. Obtener precio exacto de ADA
            const adaRes = await fetch("https://api.binance.com/api/v3/ticker/price?symbol=ADAUSDT");
            const adaData = await adaRes.json();
            const adaUsd = parseFloat(adaData.price);
            document.getElementById('ada-ticker').innerText = `ADA/USD: $${adaUsd.toFixed(4)}`;

            // 2. Pedir TODOS los pools de ORACLE a GeckoTerminal en una sola llamada
            const poolRes = await fetch(`https://api.geckoterminal.com/api/v2/networks/cardano/tokens/${ORACLE_ID}/pools`);
            const poolData = await poolRes.json();

            let tvlMinswap = 0;
            let tvlVyfi = 0;

            // 3. Analizar los pools encontrados
            for (let pool of poolData.data) {
                const dexName = pool.relationships?.dex?.data?.id || "";
                const attributes = pool.attributes;
                
                // Extraer valores crudos en USD y convertir a ADA
                const poolPriceUsd = parseFloat(attributes.base_token_price_usd) || 0;
                const poolTvlUsd = parseFloat(attributes.reserve_in_usd) || 0;
                
                const priceInAda = poolPriceUsd / adaUsd;
                const tvlInAda = poolTvlUsd / adaUsd;

                // Identificar y asignar a Minswap
                if (dexName.includes('minswap')) {
                    document.getElementById('price-minswap').innerText = priceInAda.toFixed(4) + " ₳";
                    document.getElementById('tvl-minswap').innerText = Math.round(tvlInAda).toLocaleString('es-ES') + " ₳";
                    tvlMinswap = tvlInAda;
                }
                
                // Identificar y asignar a VyFi
                if (dexName.includes('vyfi')) {
                    document.getElementById('price-vyfi').innerText = priceInAda.toFixed(4) + " ₳";
                    document.getElementById('tvl-vyfi').innerText = Math.round(tvlInAda).toLocaleString('es-ES') + " ₳";
                    tvlVyfi = tvlInAda;
                }
            }

            // 4. Calcular Total y marcar como finalizado
            const totalTvl = tvlMinswap + tvlVyfi;
            document.getElementById('total-tvl').innerText = Math.round(totalTvl).toLocaleString('es-ES') + " ₳";
            
            const statusMain = document.getElementById('status-main');
            statusMain.className = "status-dot status-ok";
            statusMain.nextSibling.textContent = " Conectado en Tiempo Real";

        } catch (error) {
            console.error("Error conectando con la blockchain:", error);
            document.getElementById('status-main').nextSibling.textContent = " Error de conexión. Reintentando...";
        }
    }

    // Iniciar y programar actualización cada 30 segundos
    fetchData();
    setInterval(fetchData, 30000);
</script>

</body>
</html>