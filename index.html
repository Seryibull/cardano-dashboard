<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L4VA Protocol | Arbitrage Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Base Palette */
            --card-bg: #120f24;
            --text-primary: #ffffff;
            --text-secondary: #a0a0c0;
            --text-on-fire: #150f26; 
            
            /* Fire Colors */
            --neon-orange: #ff7b00;
            --neon-red: #ff0f5b;
            --gradient-fire: linear-gradient(135deg, var(--neon-orange), var(--neon-red));
            --gradient-dark-fire: linear-gradient(135deg, #5e2a00 0%, #8a121c 60%, #4a0042 100%);
            
            /* Custom Brand Colors */
            --ada-color: #4285f4;
            --badge-vyfi-bg: rgba(139, 92, 246, 0.15);
            --badge-vyfi-text: #a78bfa;
            --badge-min-bg: rgba(137, 170, 255, 0.15); 
            --badge-min-text: #89aaff; 
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(rgba(10, 8, 20, 0.4), rgba(10, 8, 20, 0.75)), url('https://app.l4va.org/assets/banner-bg.webp');
            background-size: cover;
            background-position: center top;
            background-attachment: fixed;
            color: var(--text-primary); 
            margin: 0; 
            padding: 20px 20px; 
            min-height: 100vh; 
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .brand-logo { font-size: 2.5rem; filter: drop-shadow(0 0 10px var(--neon-orange)); }
        h1 { margin: 0; font-weight: 800; font-size: 1.8rem; background: var(--gradient-fire); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }

        .settings-btn {
            font-size: 1.5rem; cursor: pointer; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 12px; transition: 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .settings-btn:hover { background: rgba(255,255,255,0.15); transform: rotate(45deg); border-color: var(--neon-orange); }

        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(270px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }
        .card { border-radius: 20px; padding: 20px 25px; position: relative; background: rgba(18, 15, 36, 0.85); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6), 0 0 20px rgba(255, 123, 0, 0.15); border-color: rgba(255, 123, 0, 0.3); }

        /* Tarjeta ADA m√°s clara */
        .card-ada { background: rgba(35, 40, 65, 0.85); border-color: rgba(66, 133, 244, 0.2); }
        .card-ada:hover { border-color: rgba(66, 133, 244, 0.5); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6), 0 0 20px rgba(66, 133, 244, 0.2); }

        .card-title { font-size: 1.05rem; font-weight: 600; margin-bottom: 15px; color: var(--neon-orange); display: flex; justify-content: space-between; align-items: center; }
        .card-title.ada-title { color: var(--ada-color); text-shadow: 0 0 10px rgba(66, 133, 244, 0.3); }
        .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.95rem; }
        .data-label { color: var(--text-secondary); font-weight: 500; }
        .data-value { font-weight: 800; font-size: 1.2rem; color: var(--text-primary); }
        .badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; font-weight: 700; text-transform: uppercase; border: 1px solid transparent; }
        .bg-vyfi { background: var(--badge-vyfi-bg); color: var(--badge-vyfi-text); border-color: var(--badge-vyfi-text); }
        .bg-minswap { background: var(--badge-min-bg); color: var(--badge-min-text); border-color: var(--badge-min-text); }

        .arbitrage-section { grid-column: 1 / -1; background: var(--gradient-dark-fire) !important; border: none; box-shadow: 0 15px 40px -10px rgba(74, 0, 0, 0.8), inset 0 0 30px rgba(0,0,0,0.4); padding: 20px 25px; }
        .arbitrage-banner-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255, 255, 255, 0.15); padding-bottom: 10px; margin-bottom: 15px; }
        .arbitrage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .arbitrage-box { background: rgba(0, 0, 0, 0.3); padding: 15px 20px; border-radius: 16px; transition: all 0.3s ease; position: relative; border: 1px solid rgba(255,255,255,0.05);}
        .arbitrage-label { color: rgba(255, 255, 255, 0.7); font-size: 0.75rem; text-transform: uppercase; font-weight: 800; margin-bottom: 3px; }
        .arbitrage-big-value { font-size: 1.6rem; font-weight: 900; color: #ffffff; text-shadow: 0 2px 10px rgba(0,0,0,0.3); transition: all 0.3s ease; }
        .loading { color: inherit; opacity: 0.6; font-style: italic; font-weight: normal; font-size: 0.9rem;}

        .alert-toggle-box { font-size: 0.8rem; font-weight: 800; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--text-primary); background: rgba(255, 255, 255, 0.1); padding: 6px 12px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .alert-toggle-box input { accent-color: var(--neon-orange); transform: scale(1.1); }
        .badge-dark { background: rgba(255,255,255,0.9); color: var(--text-on-fire); font-size: 0.75rem; padding: 4px 8px; border-radius: 20px; font-weight: 800; display: inline-block; margin: 0 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-decoration: none; transition: 0.2s ease; }
        a.badge-dark:hover { transform: scale(1.08); background: #ffffff; cursor: pointer; }
        .color-minswap { color: var(--badge-min-text) !important; }
        .color-vyfi { color: var(--badge-vyfi-text) !important; }

        .sim-input { background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 5px 10px; border-radius: 8px; width: 70px; font-weight: bold; text-align: center; margin-right: 5px; font-family: 'Inter', sans-serif;}
        .sim-input:focus { outline: none; border-color: var(--neon-orange); }
        .profit-positive { color: #10b981; text-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
        .profit-negative { color: var(--neon-red); }
        .optimizer-text { font-size: 0.7rem; color: var(--text-secondary); margin-top: 8px; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 8px;}

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 20px; border: 2px solid var(--neon-orange); width: 320px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .modal-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 20px; color: white; display: flex; justify-content: space-between;}
        .setting-row { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;}
        .setting-input { width: 60px; padding: 5px; border-radius: 5px; border: none; background: rgba(255,255,255,0.1); color: white; text-align: center; font-family: 'Inter', sans-serif;}
        .setting-input-text { width: 120px; padding: 5px; border-radius: 5px; border: none; background: rgba(255,255,255,0.1); color: white; font-family: 'Inter', sans-serif;}
        .btn-save { background: var(--gradient-fire); color: white; border: none; padding: 10px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: transform 0.2s;}
        .btn-save:hover { transform: scale(1.02); }
        
        h3.dex-subtitle { margin: 0 0 10px 0; font-size: 0.9rem; display: inline-block; }
        
        /* Rutas Activas Triangulares */
        .route-active { background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.4); padding: 6px 10px; border-radius: 8px; color: #10b981; }
        .route-inactive { background: transparent; border: 1px solid transparent; padding: 6px 10px; opacity: 0.5; color: var(--text-secondary); }

        /* Estructura Fusionada Inteligente */
        .merged-section-grid {
            display: grid;
            grid-template-columns: 1fr; /* M√≥vil: una columna */
            gap: 30px;
        }
        @media (min-width: 900px) {
            .merged-section-grid {
                grid-template-columns: 3fr 2fr; /* PC: 60% izquierda, 40% derecha */
            }
            .merged-right-col {
                border-left: 1px solid rgba(255,255,255,0.1); 
                padding-left: 30px;
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div class="brand-logo">üî•</div>
            <h1>L4VA Protocol <span style="color: var(--text-secondary); font-weight: 400;">| Arbitrage Dashboard</span></h1>
        </div>
        <div class="header-right">
            <div class="settings-btn" onclick="openSettings()">‚öôÔ∏è</div>
        </div>
    </header>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title"><span>‚öôÔ∏è Preferences & Alerts</span><span style="cursor:pointer;" onclick="closeModals()">‚úï</span></div>
            <div class="setting-row"><span>Glow Threshold (%)</span><input type="number" id="set-glow" class="setting-input" value="10"></div>
            <div class="setting-row"><span>Alert Threshold (%)</span><input type="number" id="set-alert" class="setting-input" value="15"></div>
            <div class="setting-row"><span>Simulator Base (ADA)</span><input type="number" id="set-sim" class="setting-input" value="1000"></div>
            <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;"></div>
            <div style="font-size: 0.8rem; color: var(--neon-orange); margin-bottom: 10px;">Telegram Bot (Optional)</div>
            <div class="setting-row"><span>Bot Token</span><input type="text" id="set-tg-bot" class="setting-input-text" placeholder="123:ABC..."></div>
            <div class="setting-row"><span>Chat ID</span><input type="text" id="set-tg-chat" class="setting-input-text" placeholder="12345678"></div>
            <button class="btn-save" onclick="saveSettings()">Save Configuration</button>
        </div>
    </div>

    <div class="dashboard">
        <div class="card arbitrage-section">
            <div class="arbitrage-banner-header">
                <div style="font-size: 1.1rem; font-weight: 800; color: white;">‚ö° Active Opportunities & Intelligence</div>
                <label class="alert-toggle-box">
                    <input type="checkbox" id="alert-toggle" checked> üîî Alerts (<span id="alert-label">15</span>%)
                </label>
            </div>
            
            <div class="arbitrage-grid">
                <div class="arbitrage-box">
                    <div class="arbitrage-label" style="color: var(--neon-orange); margin-bottom: 8px;">DEX Arbitrage (ORACLE)</div>
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <div class="arbitrage-label">Spread</div>
                            <div class="arbitrage-big-value" id="arbitrage-spread">-%</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="arbitrage-label">Action</div>
                            <div id="arbitrage-action" style="font-size: 0.85rem; color: white;"><span class="loading">Analyzing...</span></div>
                        </div>
                    </div>
                </div>

                <div class="arbitrage-box">
                    <div class="arbitrage-label" style="color: #fcd34d; margin-bottom: 8px;">Relics Vault arbitrage opportunity (ORACLE)</div>
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <div class="arbitrage-label">Discrepancy</div>
                            <div class="arbitrage-big-value" id="vault-banner-discrepancy">-%</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="arbitrage-label">Action</div>
                            <div id="vault-arbitrage-action" style="font-size: 0.85rem; color: white;"><span class="loading">Analyzing...</span></div>
                        </div>
                    </div>
                </div>

                <div class="arbitrage-box" style="border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; justify-content: center;">
                    <div class="arbitrage-label" style="color: #10b981; margin-bottom: 8px;">Net Profit Simulator ORACLE / ADA</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="arbitrage-label">Investment</div>
                            <input type="number" id="sim-ada-input" class="sim-input" value="1000" onkeyup="recalculateSimulators()" onchange="recalculateSimulators()"> <span style="font-size: 0.7rem; font-weight: bold;">ADA</span>
                        </div>
                        <div style="text-align: right;">
                            <div class="arbitrage-label">Net Return (2 Hops)</div>
                            <div class="arbitrage-big-value" id="sim-profit" style="font-size: 1.3rem;">- ADA</div>
                        </div>
                    </div>
                    <div id="optimizer-result" class="optimizer-text">üí° <b>Auto-Optimizer:</b> Calculating...</div>
                </div>

                <div class="arbitrage-box" style="border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; justify-content: center;">
                    <div class="arbitrage-label" style="color: var(--badge-vyfi-text); margin-bottom: 8px;">NET PROFIT SIMULATOR TRIANGULAR</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="arbitrage-label">Investment</div>
                            <input type="number" id="sim-tri-input" class="sim-input" value="1000" onkeyup="recalculateSimulators()" onchange="recalculateSimulators()"> <span style="font-size: 0.7rem; font-weight: bold;">ADA</span>
                        </div>
                        <div style="text-align: right;">
                            <div class="arbitrage-label">Net Return (3 Hops)</div>
                            <div class="arbitrage-big-value" id="sim-tri-profit" style="font-size: 1.3rem;">- ADA</div>
                        </div>
                    </div>
                    <div id="tri-optimizer-result" class="optimizer-text">üí° <b>Auto-Optimizer:</b> Calculating...</div>
                </div>
            </div>
        </div>

        <div class="card card-ada"> <div class="card-title ada-title">Cardano (ADA) üíé</div>
            <div class="data-row"><span class="data-label">Price USD:</span><span class="data-value" id="ada-price-usd"><span class="loading">Loading...</span></span></div>
            <div class="data-row" style="margin-top: 15px;"><span class="data-label" style="font-size: 0.75rem;">Last Updated:</span><span class="data-value" style="font-size: 0.75rem;" id="ada-time">-</span></div>
        </div>
        <div class="card">
            <div class="card-title" style="color: #fcd34d;">Relics Vault TVL üèõÔ∏è</div>
            <div class="data-row"><span class="data-label">Total Value (ADA):</span><span class="data-value" id="vault-tvl"><span class="loading">Calculating...</span></span></div>
            <div class="data-row"><span class="data-label">Fair price:</span><span class="data-value" id="vault-fair-price">-</span></div>
            <div style="height: 40px; margin-top: 15px;"><canvas id="spark-vault"></canvas></div>
        </div>

        <div class="card">
            <div class="card-title">VLRM / ADA <span class="badge bg-vyfi">VyFi</span></div>
            <div class="data-row"><span class="data-label">Price:</span><span class="data-value" id="vlrm-price-ada"><span class="loading">Connecting...</span></span></div>
            <div class="data-row"><span class="data-label">TVL (Pool):</span><span class="data-value" id="vlrm-liq-ada">-</span></div>
            <div style="height: 40px; margin-top: 15px;"><canvas id="spark-vlrm-ada"></canvas></div>
        </div>
        <div class="card">
            <div class="card-title">VLRM / ORACLE <span class="badge bg-vyfi">VyFi</span></div>
            <div class="data-row"><span class="data-label">TVL (Cross-pool):</span><span class="data-value" id="vlrm-oracle-liq-ada"><span class="loading">Waiting...</span></span></div>
            <div style="height: 40px; margin-top: 35px;"><canvas id="spark-vlrm-oracle"></canvas></div>
        </div>

        <div class="card" style="grid-column: 1 / -1;">
            <div class="merged-section-grid">
                <div>
                    <div class="card-title" style="margin-bottom: 20px;">ORACLE / ADA Comparison (Multi-DEX) ‚öñÔ∏è</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px;">
                        <div>
                            <h3 class="dex-subtitle"><span class="badge bg-vyfi">VYFI</span></h3>
                            <div class="data-row"><span class="data-label">Price:</span><span class="data-value" id="oracle-vyfi-price">-</span></div>
                            <div class="data-row"><span class="data-label">Liquidity:</span><span class="data-value" id="oracle-vyfi-liq">-</span></div>
                            <div style="height: 40px; margin-top: 10px;"><canvas id="spark-oracle-vyfi"></canvas></div>
                        </div>
                        <div style="border-left: 2px solid rgba(255,255,255,0.05); padding-left: 20px;">
                            <h3 class="dex-subtitle"><span class="badge bg-minswap">MINSWAP</span></h3>
                            <div class="data-row"><span class="data-label">Price:</span><span class="data-value" id="oracle-min-price">-</span></div>
                            <div class="data-row"><span class="data-label">Liquidity:</span><span class="data-value" id="oracle-min-liq">-</span></div>
                            <div style="height: 40px; margin-top: 10px;"><canvas id="spark-oracle-min"></canvas></div>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <h3 class="dex-subtitle" style="color: var(--text-primary); margin:0;">Total Combined Liquidity</h3>
                        <div class="data-value" style="font-size: 1.5rem; color: var(--neon-orange);" id="oracle-total-liq">-</div>
                    </div>
                </div>

                <div class="merged-right-col">
                    <div class="card-title" style="margin-bottom: 20px;">Triangular Arbitrage (Cross-Pair) üî∫</div>
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); height: calc(100% - 60px); display: flex; flex-direction: column; justify-content: center;">
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div class="arbitrage-label">Estimated Discrepancy</div>
                            <div class="arbitrage-big-value" id="tri-arb-spread" style="font-size: 1.8rem;"><span class="loading">Scanning...</span></div>
                        </div>

                        <div style="font-size: 0.85rem; line-height: 1.8;">
                            <div id="route-a-container" class="route-inactive">
                                Route A: <span style="font-weight: bold;">Buy VLRM ‚ûî Swap for ORACLE ‚ûî Sell ORACLE</span>
                            </div>
                            <div id="route-b-container" class="route-inactive" style="margin-top: 8px;">
                                Route B: <span style="font-weight: bold;">Buy ORACLE ‚ûî Swap for VLRM ‚ûî Sell VLRM</span>
                            </div>
                        </div>
                        <div style="font-size: 0.75rem; font-style: italic; color: var(--text-secondary); margin-top: 15px;">
                            *Theoretical spot calculation. Check liquidity before execution.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" style="grid-column: 1 / -1; padding: 15px;">
            <div class="card-title" style="margin-bottom: 10px; font-size: 0.9rem;">Live Trend (Spread & Vault Discrepancy %)</div>
            <div style="height: 200px; width: 100%;">
                <canvas id="arbitrageChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const PROXY_URL = 'https://cardano-dex-proxy.seryibull.workers.dev';
        const VLRM = "63efb704b7396890e4d9539d030c0e667739043add65c00f96c586c056616c6f72756d";
        const ORACLE = "328a18bac517630826a106bff1a55caf455de84cdba98416f8e093b27393c37310950f58596be5013b942d52accb931c2800cf132db36fb5fd7d71c4";
        const ORACLE_TOTAL_SUPPLY = 1000000;
        
        const VYFI_LINK = "https://app.vyfi.io/dex?tokenA=lovelace&tokenB=328a18bac517630826a106bff1a55caf455de84cdba98416f8e093b27393c37310950f58596be5013b942d52accb931c2800cf132db36fb5fd7d71c4";
        const MINSWAP_LINK = "https://minswap.org/swap?cA=&tA=&cB=328a18bac517630826a106bff1a55caf455de84cdba98416f8e093b2&tB=7393c37310950f58596be5013b942d52accb931c2800cf132db36fb5fd7d71c4";

        let conf = JSON.parse(localStorage.getItem('l4va_config')) || { glow: 10, alert: 15, sim: 1000, tgBot: "", tgChat: "" };
        let lastAlertTime = 0;
        let chartInstance = null;
        let sparkInstances = {}; 
        const ALERT_COOLDOWN = 5 * 60 * 1000;
        
        let currentPools = {
            vyfi: { price: 0, reserveAda: 0, reserveTok: 0 },
            minswap: { price: 0, reserveAda: 0, reserveTok: 0 },
            vlrmAda: { resAda: 0, resTok: 0 },
            crossVO: { resVlrm: 0, resOracle: 0 }
        };

        // UI Initialization
        document.getElementById('sim-ada-input').value = conf.sim;
        document.getElementById('sim-tri-input').value = conf.sim;
        document.getElementById('alert-label').innerText = conf.alert;

        function closeModals() { document.getElementById('settings-modal').style.display = 'none'; }
        function openSettings() { document.getElementById('set-glow').value = conf.glow; document.getElementById('set-alert').value = conf.alert; document.getElementById('set-sim').value = document.getElementById('sim-ada-input').value; document.getElementById('set-tg-bot').value = conf.tgBot || ""; document.getElementById('set-tg-chat').value = conf.tgChat || ""; document.getElementById('settings-modal').style.display = 'flex'; }
        function saveSettings() {
            conf.glow = parseFloat(document.getElementById('set-glow').value);
            conf.alert = parseFloat(document.getElementById('set-alert').value);
            conf.sim = parseFloat(document.getElementById('set-sim').value);
            conf.tgBot = document.getElementById('set-tg-bot').value.trim();
            conf.tgChat = document.getElementById('set-tg-chat').value.trim();
            localStorage.setItem('l4va_config', JSON.stringify(conf));
            document.getElementById('sim-ada-input').value = conf.sim;
            document.getElementById('sim-tri-input').value = conf.sim;
            document.getElementById('alert-label').innerText = conf.alert;
            closeModals();
            recalculateSimulators();
        }

        async function sendTelegramAlert(message) {
            if (!conf.tgBot || !conf.tgChat) return;
            try { await fetch(`https://api.telegram.org/bot${conf.tgBot}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: conf.tgChat, text: message, parse_mode: 'HTML' }) }); } catch (e) {}
        }

        function initCharts() {
            // Main Chart
            const ctx = document.getElementById('arbitrageChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [
                    { label: 'DEX Spread %', data: [], borderColor: '#ff7b00', tension: 0.4, borderWidth: 2, pointRadius: 0 },
                    { label: 'Vault Discrepancy %', data: [], borderColor: '#fcd34d', tension: 0.4, borderWidth: 2, pointRadius: 0 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#a0a0c0' } } }, plugins: { legend: { display: true, labels: { color: '#ffffff', boxWidth: 10 } } } }
            });

            // 5 Mini Sparklines
            const sparkOptions = { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { display: false } }, plugins: { legend: { display: false }, tooltip: { enabled: false } }, layout: { padding: 0 } };
            const createSpark = (id, color) => new Chart(document.getElementById(id).getContext('2d'), { type: 'line', data: { labels: Array(20).fill(''), datasets: [{ data: Array(20).fill(null), borderColor: color, borderWidth: 2, tension: 0.4, pointRadius: 0, fill: true, backgroundColor: color.replace('1)', '0.1)') }] }, options: sparkOptions });

            sparkInstances.vlrmAda = createSpark('spark-vlrm-ada', 'rgba(167, 139, 250, 1)'); 
            sparkInstances.vlrmOracle = createSpark('spark-vlrm-oracle', 'rgba(167, 139, 250, 1)'); 
            sparkInstances.oracleVyfi = createSpark('spark-oracle-vyfi', 'rgba(167, 139, 250, 1)'); 
            sparkInstances.oracleMin = createSpark('spark-oracle-min', 'rgba(137, 170, 255, 1)'); 
            sparkInstances.vault = createSpark('spark-vault', 'rgba(252, 211, 77, 1)'); // Dorado para Vault
        }
        
        function updateSparklines(vAdaTvl, vOraTvl, oVyfiTvl, oMinTvl, vaultTvl) {
            const pushData = (chart, val) => {
                let dataArr = chart.data.datasets[0].data;
                if(dataArr[0] === null) { chart.data.datasets[0].data = Array(20).fill(val); } 
                else { dataArr.shift(); dataArr.push(val); }
                chart.update();
            };
            pushData(sparkInstances.vlrmAda, vAdaTvl);
            pushData(sparkInstances.vlrmOracle, vOraTvl);
            pushData(sparkInstances.oracleVyfi, oVyfiTvl);
            pushData(sparkInstances.oracleMin, oMinTvl);
            pushData(sparkInstances.vault, vaultTvl);
        }

        function updateMainChart(spread, discrepancy) {
            const now = new Date().toLocaleTimeString();
            if(chartInstance.data.labels.length > 20) { chartInstance.data.labels.shift(); chartInstance.data.datasets.forEach(d => d.data.shift()); }
            chartInstance.data.labels.push(now); chartInstance.data.datasets[0].data.push(spread); chartInstance.data.datasets[1].data.push(discrepancy); chartInstance.update();
        }

        function playDing() {
            try { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); const gainNode = ctx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(880, ctx.currentTime); gainNode.gain.setValueAtTime(0.1, ctx.currentTime); osc.connect(gainNode); gainNode.connect(ctx.destination); osc.start(); gainNode.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5); osc.stop(ctx.currentTime + 0.5); } catch (e) {}
        }

        function getAmmOut(amountIn, reserveIn, reserveOut) {
            if(reserveIn <= 0 || reserveOut <= 0 || amountIn <= 0) return 0;
            const feeMultiplier = 0.997; 
            const amountInWithFee = amountIn * feeMultiplier;
            return (reserveOut * amountInWithFee) / (reserveIn + amountInWithFee);
        }

        function recalculateSimulators() { recalculateDexSimulator(); recalculateTriSimulator(); }

        function recalculateDexSimulator() {
            const investAda = parseFloat(document.getElementById('sim-ada-input').value) || 0;
            const simEl = document.getElementById('sim-profit'); const optEl = document.getElementById('optimizer-result');
            if(currentPools.vyfi.price <= 0 || currentPools.minswap.price <= 0) { simEl.innerText = "0.00 ADA"; return; }
            
            const networkFee = 0.20; const minFixed = 0.70; const vyfiFixed = 1.90;
            let poolBuy, poolSell, fixedFeeBuy, fixedFeeSell;

            if (currentPools.minswap.price < currentPools.vyfi.price) { poolBuy = currentPools.minswap; poolSell = currentPools.vyfi; fixedFeeBuy = minFixed; fixedFeeSell = vyfiFixed; } 
            else { poolBuy = currentPools.vyfi; poolSell = currentPools.minswap; fixedFeeBuy = vyfiFixed; fixedFeeSell = minFixed; }

            let netProfit = 0; let swapAdaAmount = investAda - fixedFeeBuy - networkFee;
            if (swapAdaAmount > 0) {
                let tokensReceived = getAmmOut(swapAdaAmount, poolBuy.reserveAda, poolBuy.reserveTok);
                let adaGrossReceived = getAmmOut(tokensReceived, poolSell.reserveTok, poolSell.reserveAda);
                netProfit = (adaGrossReceived - fixedFeeSell - networkFee) - investAda;
            }
            
            if (swapAdaAmount <= 0) { simEl.innerText = "Insufficient ADA"; simEl.className = "arbitrage-big-value profit-negative"; } 
            else { let sign = netProfit > 0 ? "+" : ""; simEl.innerText = `${sign}${netProfit.toFixed(2)} ADA`; simEl.className = netProfit > 0 ? "arbitrage-big-value profit-positive" : "arbitrage-big-value profit-negative"; }

            let bestProfit = -Infinity; let optimalInvest = 0;
            for(let i = 10; i <= 5000; i += 10) {
                let testSwapAmount = i - fixedFeeBuy - networkFee;
                if(testSwapAmount <= 0) continue;
                let testTokens = getAmmOut(testSwapAmount, poolBuy.reserveAda, poolBuy.reserveTok);
                let testAdaGross = getAmmOut(testTokens, poolSell.reserveTok, poolSell.reserveAda);
                let testNet = (testAdaGross - fixedFeeSell - networkFee) - i;
                if (testNet > bestProfit) { bestProfit = testNet; optimalInvest = i; } else if (testNet < bestProfit && testNet > 0) break;
            }

            if (bestProfit > 0) { optEl.innerHTML = `üí° <b>Auto-Optimizer:</b> Max profit <b>+${bestProfit.toFixed(2)} ADA</b> (Invest <b>${optimalInvest} ADA</b>)`; optEl.style.color = '#10b981'; } 
            else { optEl.innerHTML = `üí° <b>Auto-Optimizer:</b> No profitable route (fees > spread).`; optEl.style.color = 'var(--text-secondary)'; }
        }

        function calcTriNet(investAda) {
            if(investAda <= 0) return -Infinity;
            let pVA = currentPools.vlrmAda; let pVO = currentPools.crossVO; let pOVy = currentPools.vyfi; let pOMin = currentPools.minswap; 
            if(pVA.resAda <= 0 || pVO.resVlrm <= 0) return -Infinity;

            const netF = 0.2; const fVy = 1.9 + netF; const fMin = 0.7 + netF; 

            let outA = -Infinity; let adaAfterLeg1A = investAda - fVy;
            if(adaAfterLeg1A > 0) {
                let vlrmOut = getAmmOut(adaAfterLeg1A, pVA.resAda, pVA.resTok);
                let oracleOut = getAmmOut(vlrmOut, pVO.resVlrm, pVO.resOracle);
                let adaEndVy = getAmmOut(oracleOut, pOVy.reserveTok, pOVy.reserveAda) - fVy - fVy; 
                let adaEndMin = getAmmOut(oracleOut, pOMin.reserveTok, pOMin.reserveAda) - fVy - fMin; 
                outA = Math.max(adaEndVy, adaEndMin);
            }

            let outB = -Infinity; let adaAfterLeg1B_Vy = investAda - fVy; let adaAfterLeg1B_Min = investAda - fMin;
            if(adaAfterLeg1B_Vy > 0 || adaAfterLeg1B_Min > 0) {
                let oracleOutVy = getAmmOut(adaAfterLeg1B_Vy, pOVy.reserveAda, pOVy.reserveTok);
                let vlrmOutVy = getAmmOut(oracleOutVy, pVO.resOracle, pVO.resVlrm);
                let finalVyVy = getAmmOut(vlrmOutVy, pVA.resTok, pVA.resAda) - fVy - fVy;
                let oracleOutMin = getAmmOut(adaAfterLeg1B_Min, pOMin.reserveAda, pOMin.reserveTok);
                let vlrmOutMin = getAmmOut(oracleOutMin, pVO.resOracle, pVO.resVlrm);
                let finalMinVy = getAmmOut(vlrmOutMin, pVA.resTok, pVA.resAda) - fVy - fVy;
                outB = Math.max(finalVyVy, finalMinVy);
            }
            return Math.max(outA, outB) - investAda; 
        }

        function recalculateTriSimulator() {
            const investAda = parseFloat(document.getElementById('sim-tri-input').value) || 0;
            const simEl = document.getElementById('sim-tri-profit'); const optEl = document.getElementById('tri-optimizer-result');
            let netProfit = calcTriNet(investAda);

            if(investAda <= 0 || netProfit === -Infinity) { simEl.innerText = "Insufficient"; simEl.className = "arbitrage-big-value profit-negative"; } 
            else { let sign = netProfit > 0 ? "+" : ""; simEl.innerText = `${sign}${netProfit.toFixed(2)} ADA`; simEl.className = netProfit > 0 ? "arbitrage-big-value profit-positive" : "arbitrage-big-value profit-negative"; }

            let bestProfit = -Infinity; let optimalInvest = 0;
            for(let i = 10; i <= 5000; i += 10) {
                let testNet = calcTriNet(i);
                if (testNet > bestProfit) { bestProfit = testNet; optimalInvest = i; } else if (testNet < bestProfit && testNet > 0) break;
            }
            if (bestProfit > 0) { optEl.innerHTML = `üí° <b>Auto-Optimizer:</b> Max profit <b>+${bestProfit.toFixed(2)} ADA</b> (Invest <b>${optimalInvest} ADA</b>)`; optEl.style.color = '#10b981'; } 
            else { optEl.innerHTML = `üí° <b>Auto-Optimizer:</b> No profitable route (fees > spread).`; optEl.style.color = 'var(--text-secondary)'; }
        }

        async function fetchAdaPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=cardano&vs_currencies=usd');
                const data = await response.json();
                document.getElementById('ada-price-usd').innerText = `$${data.cardano.usd.toFixed(4)}`;
                document.getElementById('ada-time').innerText = new Date().toLocaleTimeString();
                return data.cardano.usd;
            } catch (error) { return null; }
        }

        async function fetchDexData(adaPriceUsd) {
            if (!adaPriceUsd) return;
            try {
                const response = await fetch(PROXY_URL);
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                let vaultTvlData = 0;
                if (data.vaultTvl && data.vaultTvl > 0) {
                    vaultTvlData = data.vaultTvl;
                }

                let priceVlrmAda = 0; let vlrmVyfiAdaReserve = 0; let vlrmVyfiTokReserve = 0; let vlrmAdaTvl = 0;
                const vlrmVyfiPool = data.vyfiPools.find(p => p.unitsPair.includes('lovelace') && p.unitsPair.includes(VLRM));
                if (vlrmVyfiPool) {
                    priceVlrmAda = vlrmVyfiPool.tokenA.unit === 'lovelace' ? vlrmVyfiPool.tokenB.lpRatio[vlrmVyfiPool.unitsPair].priceRatioAB : vlrmVyfiPool.tokenA.lpRatio[vlrmVyfiPool.unitsPair].priceRatioBA;
                    vlrmAdaTvl = vlrmVyfiPool.tvl;
                    document.getElementById('vlrm-price-ada').innerText = `‚Ç≥ ${priceVlrmAda.toFixed(6)}`; document.getElementById('vlrm-liq-ada').innerText = `‚Ç≥ ${Math.round(vlrmAdaTvl).toLocaleString()}`;
                    vlrmVyfiAdaReserve = vlrmAdaTvl / 2; vlrmVyfiTokReserve = vlrmVyfiAdaReserve / priceVlrmAda;
                }
                
                let crossVlrmReserve = 0; let crossOracleReserve = 0; let crossTvl = 0;
                const crossPool = data.vyfiPools.find(p => p.unitsPair.includes(VLRM) && p.unitsPair.includes(ORACLE));
                if (crossPool) {
                    crossTvl = crossPool.tvl;
                    document.getElementById('vlrm-oracle-liq-ada').innerText = `‚Ç≥ ${Math.round(crossTvl).toLocaleString()}`; 
                    let priceOracleVlrm = crossPool.tokenA.unit.includes(VLRM) ? crossPool.tokenB.lpRatio[crossPool.unitsPair].priceRatioAB : crossPool.tokenA.lpRatio[crossPool.unitsPair].priceRatioBA;
                    crossVlrmReserve = (crossTvl / 2) / priceVlrmAda; crossOracleReserve = crossVlrmReserve / priceOracleVlrm;
                }

                let totalOracleLiqAda = 0, priceVyfi = 0, priceMin = 0; let vyfiTvLAda = 0, minTvlAda = 0;
                const oracleVyfiPool = data.vyfiPools.find(p => p.unitsPair.includes('lovelace') && p.unitsPair.includes(ORACLE));
                if (oracleVyfiPool) {
                    priceVyfi = oracleVyfiPool.tokenA.unit === 'lovelace' ? oracleVyfiPool.tokenB.lpRatio[oracleVyfiPool.unitsPair].priceRatioAB : oracleVyfiPool.tokenA.lpRatio[oracleVyfiPool.unitsPair].priceRatioBA;
                    vyfiTvLAda = oracleVyfiPool.tvl; totalOracleLiqAda += vyfiTvLAda;
                    document.getElementById('oracle-vyfi-price').innerText = `‚Ç≥ ${priceVyfi.toFixed(6)}`; document.getElementById('oracle-vyfi-liq').innerText = `‚Ç≥ ${Math.round(vyfiTvLAda).toLocaleString()}`;
                }
                
                if (data.minPrice && data.minPrice.length > 0) {
                    priceMin = parseFloat(data.minPrice[0].close); document.getElementById('oracle-min-price').innerText = `‚Ç≥ ${priceMin.toFixed(6)}`;
                    if (data.minTvl && data.minTvl.length > 0) { minTvlAda = parseFloat(data.minTvl[data.minTvl.length - 1].value); totalOracleLiqAda += minTvlAda; document.getElementById('oracle-min-liq').innerText = `‚Ç≥ ${Math.round(minTvlAda).toLocaleString()}`; }
                }
                document.getElementById('oracle-total-liq').innerText = `‚Ç≥ ${Math.round(totalOracleLiqAda).toLocaleString()}`;

                // Update ALL 5 Sparklines
                updateSparklines(vlrmAdaTvl, crossTvl, vyfiTvLAda, minTvlAda, vaultTvlData);

                currentPools.vyfi = { price: priceVyfi, reserveAda: priceVyfi > 0 ? (vyfiTvLAda / 2) : 0, reserveTok: priceVyfi > 0 ? (vyfiTvLAda / 2) / priceVyfi : 0 };
                currentPools.minswap = { price: priceMin, reserveAda: priceMin > 0 ? (minTvlAda / 2) : 0, reserveTok: priceMin > 0 ? (minTvlAda / 2) / priceMin : 0 };
                currentPools.vlrmAda = { resAda: vlrmVyfiAdaReserve, resTok: vlrmVyfiTokReserve }; currentPools.crossVO = { resVlrm: crossVlrmReserve, resOracle: crossOracleReserve };

                // TRIANGULAR HIGHLIGHT LOGIC
                if (priceVlrmAda > 0 && crossOracleReserve > 0 && priceVyfi > 0) {
                    let routeA_Cost = (crossVlrmReserve / crossOracleReserve) * priceVlrmAda; 
                    let bestDirectMarketPrice = Math.max(priceVyfi, priceMin);
                    let triArbDiff = ((bestDirectMarketPrice - routeA_Cost) / routeA_Cost) * 100;
                    
                    const triEl = document.getElementById('tri-arb-spread');
                    const rA = document.getElementById('route-a-container');
                    const rB = document.getElementById('route-b-container');

                    // Reset
                    rA.className = "route-inactive"; rB.className = "route-inactive";

                    if(Math.abs(triArbDiff) < 0.5) {
                        triEl.innerText = "Balanced"; triEl.style.color = "var(--text-secondary)";
                    } else {
                        let sign = triArbDiff > 0 ? '+' : '';
                        triEl.innerText = `${sign}${Math.abs(triArbDiff).toFixed(2)}%`;
                        triEl.style.color = "#10b981";

                        // Highlight Winning Route
                        if (triArbDiff > 0) {
                            rA.className = "route-active";
                        } else {
                            rB.className = "route-active";
                        }
                    }
                }

                let bestDeviation = 0;
                if (vaultTvlData > 0) {
                    const fairPrice = vaultTvlData / ORACLE_TOTAL_SUPPLY;
                    document.getElementById('vault-tvl').innerText = `‚Ç≥ ${Math.round(vaultTvlData).toLocaleString()}`; document.getElementById('vault-fair-price').innerText = `‚Ç≥ ${fairPrice.toFixed(6)}`;
                    let validPrices = [];
                    if (priceVyfi > 0) validPrices.push({ dex: "VyFi", price: priceVyfi }); if (priceMin > 0) validPrices.push({ dex: "Minswap", price: priceMin });

                    if (validPrices.length > 0) {
                        let targetDex = "";
                        validPrices.forEach(p => { let deviation = ((p.price - fairPrice) / fairPrice) * 100; if (Math.abs(deviation) > Math.abs(bestDeviation)) { bestDeviation = deviation; targetDex = p.dex; } });
                        const vaultBannerDiscEl = document.getElementById('vault-banner-discrepancy'); const vaultActionEl = document.getElementById('vault-arbitrage-action');
                        let sign = bestDeviation > 0 ? '+' : ''; vaultBannerDiscEl.innerText = `${sign}${bestDeviation.toFixed(2)}%`;

                        let targetLink = targetDex === "Minswap" ? MINSWAP_LINK : VYFI_LINK; let dexColorClass = targetDex === "Minswap" ? "color-minswap" : "color-vyfi";
                        if (Math.abs(bestDeviation) < 0.5) {
                            vaultBannerDiscEl.className = 'arbitrage-big-value'; vaultBannerDiscEl.style.color = "rgba(255, 255, 255, 0.5)"; vaultBannerDiscEl.style.textShadow = "0 2px 10px rgba(0,0,0,0.3)"; vaultActionEl.innerHTML = `<span style="color: rgba(255, 255, 255, 0.6);">Balanced</span>`;
                        } else {
                            vaultBannerDiscEl.style.color = ""; vaultBannerDiscEl.className = `arbitrage-big-value ${dexColorClass}`;
                            if (Math.abs(bestDeviation) >= conf.glow) { let glowColor = targetDex === "Minswap" ? "rgba(137, 170, 255, 0.6)" : "rgba(167, 139, 250, 0.6)"; vaultBannerDiscEl.style.textShadow = `0 0 15px ${glowColor}`; } else { vaultBannerDiscEl.style.textShadow = "0 2px 10px rgba(0,0,0,0.3)"; }
                            if (bestDeviation > 0) { vaultActionEl.innerHTML = `Sell <a href="${targetLink}" target="_blank" class="badge-dark">${targetDex}</a>`; } else { vaultActionEl.innerHTML = `Buy <a href="${targetLink}" target="_blank" class="badge-dark">${targetDex}</a>`; }
                        }
                    }
                }

                let spread = 0;
                if (priceVyfi > 0 && priceMin > 0) {
                    const highestPrice = Math.max(priceVyfi, priceMin); const lowestPrice = Math.min(priceVyfi, priceMin); spread = ((highestPrice - lowestPrice) / lowestPrice) * 100;
                    const spreadEl = document.getElementById('arbitrage-spread'); const actionEl = document.getElementById('arbitrage-action');
                    spreadEl.innerText = `${spread.toFixed(2)}%`;
                    let suggestedActionText = "";
                    if (spread < 0.5) {
                        spreadEl.style.color = "rgba(255, 255, 255, 0.5)"; spreadEl.style.textShadow = "0 2px 10px rgba(0,0,0,0.3)"; actionEl.innerHTML = `<span style="color: rgba(255, 255, 255, 0.6);">Low spread</span>`;
                    } else {
                        spreadEl.style.color = "#ffffff"; 
                        if (spread >= conf.glow) { spreadEl.style.textShadow = "0 0 15px rgba(255, 255, 255, 0.7)"; } else { spreadEl.style.textShadow = "0 2px 10px rgba(0,0,0,0.3)"; }
                        if (priceVyfi > priceMin) { actionEl.innerHTML = `Buy <a href="${MINSWAP_LINK}" target="_blank" class="badge-dark">Min</a> ‚ûî Sell <a href="${VYFI_LINK}" target="_blank" class="badge-dark">VyFi</a>`; suggestedActionText = "Buy on Minswap, Sell on VyFi"; } 
                        else { actionEl.innerHTML = `Buy <a href="${VYFI_LINK}" target="_blank" class="badge-dark">VyFi</a> ‚ûî Sell <a href="${MINSWAP_LINK}" target="_blank" class="badge-dark">Min</a>`; suggestedActionText = "Buy on VyFi, Sell on Minswap"; }
                    }

                    if (spread >= conf.alert) {
                        const alertToggle = document.getElementById('alert-toggle'); const now = Date.now();
                        if (alertToggle && alertToggle.checked && (now - lastAlertTime > ALERT_COOLDOWN)) {
                            playDing(); if (Notification.permission === "granted") { new Notification("üö® L4VA Arbitrage Detected!", { body: `Spread: ${spread.toFixed(2)}%\n${suggestedActionText}` }); }
                            sendTelegramAlert(`üö® <b>L4VA Arbitrage Detected!</b>\n\nüìà DEX Spread: <b>${spread.toFixed(2)}%</b>\nüí° Route: ${suggestedActionText}\n\n<i>Check dashboard for real-time net profit.</i>`);
                            lastAlertTime = now;
                        }
                    }
                }

                updateMainChart(spread, bestDeviation);
                recalculateSimulators();

            } catch (error) { console.error("General error:", error); }
        }

        async function initDashboard() {
            initCharts();
            const adaPriceUsd = await fetchAdaPrice();
            await fetchDexData(adaPriceUsd);
            setInterval(async () => {
                const updatedAdaPrice = await fetchAdaPrice();
                await fetchDexData(updatedAdaPrice);
            }, 30000);
        }
        window.onload = initDashboard;
    </script>
</body>
</html>